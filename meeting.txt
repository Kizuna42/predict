
## 1. プロジェクト全体像

### 目的
**空調システムの室内温度を高精度で予測し、効率的な空調制御を実現する**
- 各ゾーンの将来温度（5分後〜30分後）を予測

### 対象システム
- **12ゾーン**の空調システム（L系統[0,1,6,7]、M系統[2,3,8,9]、R系統[4,5,10,11]）
- **5つの予測ホライゾン**：5分後、10分後、15分後、20分後、30分後
- **時系列データ**：約119MBのAllDayData.csv（5分間隔サンプリング）

---

## 2. 予測モデルの仕組み

### 使用アルゴリズム
**LightGBM（勾配ブースティング）** + **物理法則ベースの特徴量エンジニアリング**

### 入力データ（特徴量）
#### A. センサーデータ
- **温度センサー**：`sens_temp_{zone}`（各ゾーンの現在温度）
- **湿度センサー**：`sens_humid_{zone}`（利用可能な場合）
- **平滑化処理**：`sens_temp_{zone}_smoothed_w{window}`（ノイズ除去済みの温度データ）

#### B. 空調制御データ
- **空調ON/OFF状態**：`AC_valid_{zone}`
- **冷暖房モード**：`AC_mode_{zone}`
- **設定温度**：`AC_set_{zone}`
- **サーモ状態**：`thermo_state_{zone}`（センサー温度と設定温度の差）

#### C. 環境データ
- **外気温**：`atmospheric temperature`
- **日射量**：`total solar radiation`

#### D. 物理ベース特徴量（自動生成）
- **温度変化率**：`temp_rate_{zone}`
- **設定温度との差**：`temp_diff_to_setpoint_{zone}`
- **外気温との温度差**：`temp_diff_to_outside_{zone}`
- **空調応答性**：`setpoint_response_{zone}`
- **空調温度相互作用**：`ac_temp_interaction_{zone}`

#### E. 未来情報（重要な特徴）
- **未来の空調制御状態**：`{feature}_future_{horizon}`（例：`AC_valid_{zone}_future_15`）
- **未来の環境データ**：`{feature}_future_{horizon}`（例：`atmospheric_temperature_future_15`）

#### F. 多項式特徴量
- 2次交互作用：`poly_{feature1}_{feature2}`（例：温度×湿度、空調状態×外気温）

#### G. 時間特徴量
- **時間**：`hour`

#### ※ 補足
- `{window}`: 平滑化ウィンドウサイズ
- `{horizon}`: 予測ホライゾン（5, 10, 15, 20, 30分）

---
### 出力結果
- **各ゾーンの予測温度**：指定した時間後の室温
- **予測精度指標**：RMSE（平均誤差）、R²（決定係数）
- **特徴量重要度**：どの要素が予測に重要かの分析

---

## 3. モデル性能

### 現在の精度（ゾーン1、15分後予測の例）
- **R² = 0.88**
- **RMSE = 0.84℃**（平均予測誤差が1℃未満）
- **MAE = 0.67℃**（平均絶対誤差）

### 特徴量重要度の分析結果
1. **未来の空調制御状態**：95.7%
2. **現在の温度センサー値**：4.3%
3. **その他の物理特徴量**：微小

- **テストデータでの性能**：トレーニングデータより良好（過学習なし）

---

## 4. 技術的特徴

### データ処理
- **欠損値処理**：前方・後方補間
- **外れ値除去**：300℃以上の異常値を自動除去
- **平滑化処理**：複数ウィンドウサイズでノイズ除去

### 特徴量エンジニアリング
- **物理法則ベース**：熱力学の原理に基づく特徴量生成
- **自動特徴選択**：LightGBMベースの重要度による選択
- **多項式特徴量**：非線形関係の自動検出

### モデル最適化
- **重み付き学習**：急激な温度変化に重点を置いた学習
- **交差検証**：時系列データに適した検証手法
- **ハイパーパラメータ調整**：物理モデルに適した設定

---

## 5. 成果物

### 予測モデル
- **12ゾーン × 5ホライゾン = 60個**の専用モデル
- **保存形式**：pickle形式で再利用可能
- **特徴量情報**：各モデルの使用特徴量リスト

### 可視化ツール
- **実測値vs予測値**：散布図による精度確認
- **時系列プロット**：時間軸での予測追跡
- **詳細分析**：日/時/週単位での詳細可視化
- **LAG依存度分析**：過去データへの依存度評価

### 分析レポート
- **特徴量重要度**：どの要素が重要かの定量分析
- **予測精度評価**：RMSE、MAE、R²による性能評価

---

## 6. 最新の改善内容（2024年12月実装）

### 特徴量エンジニアリングの最適化
#### A. 統合パイプライン関数の実装
- **`create_optimized_features_pipeline`**：全ての特徴量処理を統合
- **自動化された処理フロー**：データ前処理から特徴量選択まで一括実行
- **処理効率の向上**：重複処理の排除とメモリ使用量の最適化

#### B. ノイズ対策の強化
- **移動平均による平滑化**：`apply_smoothing_to_sensors`関数
- **未来情報を含まない設計**：リークを防ぐ適切な時系列処理
- **複数ウィンドウサイズ対応**：データ特性に応じた最適化

#### C. 特徴量の整理と統合
- **AC_setとAC_tempの統合**：サーモ状態特徴量に一本化
- **重複特徴量の自動除去**：計算効率とモデル性能の向上
- **重要特徴量の優先選択**：物理的意味のある特徴量を重視

### 未来情報の活用強化
#### A. 制御パラメータの未来情報
- **空調制御状態**：`AC_valid_{zone}_future_{horizon}`
- **冷暖房モード**：`AC_mode_{zone}_future_{horizon}`
- **設定温度**：`AC_set_{zone}_future_{horizon}`

#### B. 環境データの未来情報
- **外気温**：`atmospheric_temperature_future_{horizon}`
- **日射量**：`solar_radiation_future_{horizon}`

#### C. サーモ状態の未来情報
- **未来サーモ状態**：`thermo_state_{zone}_future_{horizon}`

### 可視化機能の大幅改善
#### A. 予測誤差プロットの削除
- **ユーザビリティ向上**：不要な情報を削除してシンプル化
- **レイアウト最適化**：重要な情報に集中

#### B. 横軸の大幅拡大と超高解像度対応
- **図のサイズ拡大**：
  - 単一ゾーン：16×8 → 24×10
  - 複数ゾーン：20×10 → 28×10、20×16 → 28×16
  - 多ゾーン：24×8 → 32×8
- **時間軸の細分化**：
  - **分軸（新規追加）**：15分間隔（5分副目盛）- 超高解像度分析
  - 時間軸：2時間間隔 → 1時間間隔（30分副目盛）
  - 日軸：6時間間隔 → 3時間間隔（1時間副目盛）
  - 週軸：1日間隔 → 12時間間隔（6時間副目盛）

#### C. 詳細時系列分析の強化
- **複数時間スケール対応**：minute/hour/day/week軸での詳細分析
- **超高解像度分単位可視化**：2時間、6時間、12時間の詳細分析
- **LAG依存度分析**：過去データへの依存度を可視化
- **統計情報の充実**：MAE、RMSE、R²の詳細表示

### モデル性能の向上
#### A. 特徴量選択の改良
- **`select_important_features_enhanced`**：重要特徴量パターンを優先
- **物理的意味を重視**：サーモ状態、外気温、日射量を優先選択
- **計算効率の向上**：不要な特徴量の事前除去

#### B. LAG依存度の監視強化
- **依存度閾値の設定**：30%以上で警告、15%以上で注意
- **系統別分析**：L/M/R系統ごとの特性把握
- **自動警告システム**：問題のあるモデルの早期発見

### 実行結果（テストケース）
#### ゾーン1、15分後予測
- **R² = 0.8769**（決定係数）
- **RMSE = 0.8619℃**（平均二乗誤差）
- **MAE = 0.6860℃**（平均絶対誤差）
- **LAG依存度 = 0.00%**（適切な未来情報活用）

#### ゾーン2、15分後予測
- **R² = 0.8732**（決定係数）
- **RMSE = 1.0170℃**（平均二乗誤差）
- **MAE = 0.8320℃**（平均絶対誤差）
- **LAG依存度 = 0.00%**（適切な未来情報活用）

### 生成される可視化ファイル
1. **基本可視化**
   - `scatter_all_zones_horizon_*.png`：実測値vs予測値散布図
   - `timeseries_all_zones_horizon_*.png`：基本時系列プロット

2. **詳細時系列分析**
   - `enhanced_detailed_timeseries_all_zones_horizon_*_minute_0.5days.png`：分軸12時間
   - `enhanced_detailed_timeseries_all_zones_horizon_*_hour_3days.png`：時軸3日間
   - `enhanced_detailed_timeseries_all_zones_horizon_*_day_7days.png`：日軸7日間
   - `enhanced_detailed_timeseries_all_zones_horizon_*_week_14days.png`：週軸14日間

3. **超高解像度分単位可視化**
   - `enhanced_detailed_timeseries_all_zones_horizon_*_minute_0.083days.png`：2時間詳細
   - `enhanced_detailed_timeseries_all_zones_horizon_*_minute_0.25days.png`：6時間詳細
   - `enhanced_detailed_timeseries_all_zones_horizon_*_minute_0.5days.png`：12時間詳細

### 技術的改善点
#### A. コードの保守性向上
- **モジュール化**：機能別の関数分離
- **エラーハンドリング**：堅牢な例外処理
- **ドキュメント化**：詳細なコメントと使用例

#### B. 実行効率の向上
- **メモリ使用量削減**：不要なデータの早期削除
- **計算時間短縮**：効率的なアルゴリズムの採用
- **並列処理対応**：将来の拡張に備えた設計

#### C. 設定の柔軟性
- **パラメータ化**：閾値や設定の外部化
- **テストモード**：開発時の効率的なテスト実行
- **スケーラビリティ**：ゾーン数やホライゾン数の拡張対応

---

## 7. 今後の展開

### 短期的改善（1-2ヶ月）
- **リアルタイム予測システム**：ストリーミングデータ対応
- **予測精度のさらなる向上**：アンサンブル手法の導入
- **異常検知機能**：予測外れの自動検出

### 中期的展開（3-6ヶ月）
- **制御システムとの統合**：予測結果に基づく自動制御
- **エネルギー効率最適化**：消費電力を考慮した制御戦略
- **多建物対応**：他の建物への展開

### 長期的ビジョン（6ヶ月以上）
- **AI制御システム**：完全自動化された空調制御
- **予測保守**：設備故障の事前予測
- **スマートビル統合**：総合的な建物管理システム

---
