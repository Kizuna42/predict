# フィルタリング閾値最適化結果レポート

## 🎯 最適化の目的

差分予測における高値データフィルタリングの最適な閾値を見つけ、予測精度を最大化する。

## 📊 テスト条件

- **対象**: ゾーン 1、15 分後予測
- **テスト範囲**: 60%～ 95%パーセンタイル（5%刻み）
- **評価指標**: 復元温度 RMSE、MAE、R²、方向精度
- **総合評価**: 重み付けスコア（RMSE 40% + MAE 30% + R² 30%）

## 🏆 最適化結果

### 総合最適閾値: **60 パーセンタイル**

| 指標          | 値          | 備考           |
| ------------- | ----------- | -------------- |
| 復元温度 RMSE | **0.4558℃** | 全テスト中最低 |
| 復元温度 MAE  | 0.3409℃     | 2 番目に良い   |
| 復元温度 R²   | **0.9612**  | 全テスト中最高 |
| 方向精度      | 76.4%       | 中程度         |
| データ削減率  | 59.2%       | 適度な削減     |
| 総合スコア    | **0.997**   | 最高スコア     |

### 各閾値の詳細比較

| パーセンタイル | RMSE       | MAE        | R²         | 方向精度  | データ削減率 | 総合スコア |
| -------------- | ---------- | ---------- | ---------- | --------- | ------------ | ---------- |
| **60%**        | **0.4558** | 0.3409     | **0.9612** | 76.4%     | 59.2%        | **0.997**  |
| 65%            | 0.4617     | **0.3392** | 0.9591     | 78.8%     | 64.9%        | 0.981      |
| 70%            | 0.4768     | 0.3514     | 0.9564     | 79.7%     | 69.9%        | 0.917      |
| 75%            | 0.5071     | 0.3740     | 0.9485     | 79.2%     | 75.0%        | 0.784      |
| 80%            | 0.5305     | 0.3881     | 0.9439     | 81.3%     | 79.8%        | 0.694      |
| 85%            | 0.5567     | 0.4023     | 0.9395     | 83.0%     | 84.9%        | 0.600      |
| 90%            | 0.5992     | 0.4350     | 0.9327     | 84.1%     | 89.7%        | 0.428      |
| 95%            | 0.6818     | 0.4828     | 0.8889     | **86.0%** | 94.9%        | 0.000      |

## 📈 主要な発見

### 1. **60%ile が最適**

- **RMSE**: 0.4558℃（最低値）
- **R²**: 0.9612（最高値）
- **バランス**: 精度とデータ量の最適なバランス

### 2. **閾値上昇による影響**

- **精度低下**: 閾値が高くなるほど RMSE、MAE が悪化
- **方向精度向上**: 高い閾値ほど変化方向の予測精度は向上
- **データ不足**: 95%ile では訓練データが 7,571 行まで減少

### 3. **データ削減の効果**

- **59.2%削減**: 187,097 行 → 76,272 行
- **品質向上**: 大きな変化量データに特化することで精度向上
- **効率性**: 訓練時間も 63.8 秒と適度

## 🎯 推奨設定

### 最終推奨: **60 パーセンタイル**

**理由:**

1. **最高の予測精度**: RMSE 0.4558℃、R² 0.9612
2. **十分なデータ量**: 76,272 行（59.2%削減）で安定した学習
3. **実用性**: 方向精度 76.4%で実用的な変化予測
4. **総合性能**: 全指標を考慮した最高の総合スコア

### 実装済み改善

- メインシステムの差分予測で 60%ile フィルタリングを採用
- フォールバック機能: データ不足時は 50%ile に自動調整
- 高度な重み付け戦略との組み合わせで更なる精度向上

## 📊 性能向上の確認

### 最適化前（90%ile）vs 最適化後（60%ile）

- **RMSE 改善**: 約 24%向上（推定）
- **R² 改善**: 約 2%向上（推定）
- **データ量**: 約 3 倍増加（安定性向上）
- **訓練効率**: より多くのデータでロバストな学習

## 🔮 今後の展開

1. **他ゾーンでの検証**: ゾーン 2-10 での最適閾値確認
2. **ホライゾン別最適化**: 10 分、30 分予測での最適閾値調査
3. **動的閾値**: 時期や条件に応じた適応的フィルタリング
4. **アンサンブル**: 複数閾値モデルの組み合わせ

---

**結論**: 60 パーセンタイルフィルタリングにより、差分予測の精度を大幅に向上させることに成功。RMSE 0.4558℃、R² 0.9612 という優秀な性能を達成し、実用的な温度変化予測システムを構築した。
